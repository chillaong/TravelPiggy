<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…è¡Œå°çŒª Travel Piggy</title>
    <link href="https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #fdf6e3; --accent: #ff9d00; --text-font: 'Zhi Mang Xing', cursive; }
        body { margin: 0; background: #222; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: "PingFang SC", sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* 9:16 æ¸¸æˆå®¹å™¨ */
        #game-view { position: relative; width: 100vw; height: calc(100vw * 16 / 9); max-height: 100vh; max-width: calc(100vh * 9 / 16); background: var(--bg-color); overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        /* é€šç”¨åœºæ™¯ç±» */
        .scene { position: absolute; width: 100%; height: 100%; display: none; background-size: cover; background-position: center; }
        .active { display: block; }

        /* --- è§’è‰²åŠ¨ç”» --- */
        .pig-container { position: absolute; bottom: 3%; left: 50%; transform: translateX(-50%); width: 45%; cursor: pointer; z-index: 10; transition: opacity 0.5s; }
        #pig-img { width: 100%; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2)); }
        .breathe { animation: breathe 3s ease-in-out infinite; }
        @keyframes breathe { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-3%) scale(1.02); } }

        /* --- åº­é™¢æ˜Ÿæ˜Ÿç³»ç»Ÿ (å‡çº§ç‰ˆ) --- */
        #star-zone { position: absolute; top: 60%; left: 10%; width: 80%; height: 25%; z-index: 5; pointer-events: none; }
        .star { 
            position: absolute; width: 75px; height: 75px; 
            /* æ³¨æ„ï¼šè¿™é‡Œå¼•ç”¨äº† assets/items/items.png */
            background: url('assets/items/items.png') no-repeat; 
            background-size: 590px; background-position: center top; 
            cursor: pointer; pointer-events: auto;
            animation: float 2s ease-in-out infinite;
            filter: drop-shadow(0 0 5px gold);
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        /* æ˜Ÿæ˜Ÿé£è¡ŒåŠ¨æ•ˆç²’å­ */
        .fly-star { position: absolute; width: 39px; height: 39px; background: gold; border-radius: 50%; pointer-events: none; z-index: 99; transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
        .float-text { position: absolute; color: #ff9d00; font-weight: bold; font-size: 24px; pointer-events: none; animation: fadeUp 1s forwards; z-index: 100; text-shadow: 0 2px 0 white; }
        @keyframes fadeUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* --- UI ç•Œé¢ --- */
        /* é¡¶éƒ¨ä½™é¢ (æ”¹ä¸ºå³ä¸Šè§’å¸ƒå±€ï¼Œé¿è®©ç›¸å†ŒæŒ‰é’®) */
        .hud-balance { position: absolute; top: 25px; left: 20px; background: rgba(255,255,255,0.9); padding: 8px 15px; border-radius: 30px; font-weight: bold; font-size: 18px; display: flex; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 50; }
        .hud-icon { display: flex; align-items: center; justify-content: center; margin-right: 8px; }
        
        /* ç›¸å†ŒæŒ‰é’® */
        .btn-album { position: absolute; top: 25px; right: 20px; background: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid #ddd; z-index: 50; }

        /* åº•éƒ¨å¯¼èˆª */
        .nav-bar { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box; pointer-events: none; }
        .nav-btn { pointer-events: auto; width: 70px; height: 70px; background: white; border-radius: 50%; border: 4px solid var(--accent); box-shadow: 0 5px 0 #cc7e00; font-size: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; }
        .nav-btn:active { transform: translateY(4px); box-shadow: none; }

        /* --- å¼¹çª—é€šç”¨ --- */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 100; backdrop-filter: blur(5px); }
        .close-btn { position: absolute; top: 20px; right: 20px; font-size: 40px; color: white; cursor: pointer; z-index: 102; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        /* --- å•†åº—é¢æ¿ --- */
        #shop-panel { position: absolute; bottom: 0; width: 100%; height: 60%; background: #fffcf5; border-radius: 30px 30px 0 0; padding: 20px; box-sizing: border-box; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .shop-item { display: flex; align-items: center; background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 2px solid #eee; }
        .item-sprite { width: 50px; height: 50px; background: url('assets/items/items.png?v=20260208') no-repeat; background-size: 350px; margin-right: 15px; flex-shrink: 0; }
        .buy-btn { margin-left: auto; background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* --- ä¸–ç•Œåœ°å›¾ --- */
        /* æ³¨æ„ï¼šåœ°å›¾ UI æ”¾åœ¨ assets/ui/ ä¸‹ */
        #map-view { width: 100%; height: 100%; background: url('assets/ui/WorldMap_UI.jpg?v=20260208') no-repeat center center; background-size: cover; position: relative; }
        .map-pin { position: absolute; width: 40px; height: 40px; transform: translate(-50%, -100%); cursor: pointer; }
        .pin-locked { width: 20px; height: 20px; background: rgba(0,0,0,0.2); border-radius: 50%; border: 2px dashed #666; }
        /* è§£é”çš„Pinå›¾ï¼Œå¤ç”¨ items.png é‡Œçš„å›¾æ ‡æˆ– pig å¤´åƒ */
        .pin-unlocked { 
            width: 50px; height: 50px; 
            background: url('assets/characters/pig_selfie.png?v=20260208') no-repeat center; 
            background-size: cover; 
            border-radius: 50%; border: 3px solid white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            animation: bounce 2s infinite; 
        }
        @keyframes bounce { 0%, 100% { transform: translate(-50%, -100%); } 50% { transform: translate(-50%, -110%); } }

        /* --- æ‹ç«‹å¾—ç…§ç‰‡è¯¦æƒ… --- */
        #photo-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; aspect-ratio: 3/4; perspective: 1000px; }
        .polaroid { position: relative; width: 100%; height: 100%; overflow: visible; transform: rotate(-2deg); box-shadow: 0 20px 50px rgba(0,0,0,0.5); transition: transform 0.3s; }
        /* è¿™é‡Œçš„ frame ä¹Ÿåœ¨ ui æ–‡ä»¶å¤¹ */
        .polaroid img.frame { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; }
        .polaroid img.bg { position: absolute; width: 96%; height: 88%; object-fit: contain; top: 2%; left: 2%; z-index: 1; border-radius: 2px; display: block; }
        .polaroid img.char { position: absolute; bottom: 25%; right: 10%; width: 45%; height: auto; z-index: 5; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3)); display: block; }
        .photo-text { position: absolute; bottom: 5%; width: 100%; text-align: center; font-family: 'Zhi Mang Xing', cursive; font-size: 24px; color: #444; z-index: 30; transform: rotate(2deg); opacity: 0.9; }

    </style>
</head>
<body>

<div id="game-view">
    <div id="scene-room" class="scene active" style="background-image: url('assets/scenes/room.png?v=20260208');">
        <div class="pig-container" onclick="interactPig()">
            <img id="pig-img" src="assets/characters/pig_idel.png?v=20260208" class="breathe" alt="å°çŒª">
        </div>
        <div class="nav-bar">
            <div class="nav-btn" onclick="toggleShop(true)">ğŸ’</div>
            <div class="nav-btn" onclick="switchScene('scene-garden')">ğŸ¡</div>
        </div>
    </div>

    <div id="scene-garden" class="scene" style="background-image: url('assets/scenes/magic_garden.png?v=20260208');">
        <div id="star-zone"></div>
        <div class="nav-bar" style="justify-content: center;">
            <div class="nav-btn" onclick="switchScene('scene-room')">ğŸ </div>
        </div>
    </div>

    <div class="hud-balance">
        <div class="hud-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="#FFD700" stroke="#FFA500" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
        <span id="star-count">0</span>
    </div>
    <div class="btn-album" onclick="toggleAlbum(true)">ğŸ“· ç›¸å†Œ</div>

    <div id="overlay-shop" class="overlay" onclick="toggleShop(false)">
        <div id="shop-panel" onclick="event.stopPropagation()">
            <h2 style="text-align:center; color:#555;">å‡†å¤‡æ—…è¡Œ</h2>
            <div id="shop-list"></div>
        </div>
    </div>

    <div id="overlay-album" class="overlay">
        <div class="close-btn" onclick="toggleAlbum(false)">Ã—</div>
        <div id="map-view">
            </div>
    </div>

    <div id="overlay-photo" class="overlay" onclick="closePhoto()">
        <div class="close-btn" onclick="closePhoto()">Ã—</div>
        <div id="photo-modal" onclick="event.stopPropagation()">
            <div class="polaroid" id="polaroid-card">
                <img class="frame" src="assets/ui/frame.png?v=20260208">
                <img class="bg" id="p-bg" src="">
                <img class="char" id="p-char" src="assets/characters/pig_selfie.png">
                <div class="photo-text" id="p-text"></div>
            </div>
            <p style="text-align:center; color:white; margin-top:20px; font-size:20px; opacity:0.7; cursor:pointer;" onclick="closePhoto()">âŒ</p>
        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒé…ç½® ---
    let stars = parseInt(localStorage.getItem('pig_stars')) || 20;
    let album = JSON.parse(localStorage.getItem('pig_album')) || [];
    let travelEndTime = localStorage.getItem('pig_travel_end') || null;

    // åœ°ç‚¹æ•°æ® (æ³¨æ„å›¾ç‰‡è·¯å¾„ç»Ÿä¸€åœ¨ assets/scenes/postcards/)  
    const locations = [
        { id: 'LA', name: 'æ´›æ‰çŸ¶', x: 18, y: 35, text: 'è¸©ä¸Šæ˜Ÿå…‰å¤§é“å•¦ï¼âœ¨', img: 'assets/scenes/postcards/LosAngeles.png' },
        { id: 'Paris', name: 'å·´é»', x: 48, y: 28, text: 'é“å¡”ä¸‹çš„é£å¥½æ¸©æŸ”ï½ğŸ—¼', img: 'assets/scenes/postcards/Paris.png' },
        { id: 'Egypt', name: 'åŸƒåŠ', x: 54, y: 42, text: 'é‡‘å­—å¡”çš„ç¥ç§˜è§¦æ‰‹å¯åŠğŸœï¸', img: 'assets/scenes/postcards/Egypt.png' },
        { id: 'Ushuaia', name: 'ä¹Œæ–¯æ€€äºš', x: 28, y: 82, text: 'åœ¨ä¸–ç•Œå°½å¤´çœ‹å†°å·â„ï¸', img: 'assets/scenes/postcards/Ushuaia.png' },
        { id: 'Tasmania', name: 'å¡”æ–¯é©¬å°¼äºš', x: 82, y: 78, text: 'å—åŠçƒçš„æå…‰çœ‹åˆ°å•¦ï¼ğŸŒŒ', img: 'assets/scenes/postcards/Aurora.png' }
    ];

    // é“å…·é…ç½® (åŸºäº items.png)
    const items = [
        { name: 'å·§å…‹åŠ›', cost: 5, time: 0.5, pos: '-10px -60px' }, 
        { name: 'æ±‰å ¡', cost: 20, time: 3, pos: '-130px -60px' },
        { name: 'å¸ç¯·', cost: 50, time: 5, pos: '-30px -130px' }
    ];

    function updateUI() {
        document.getElementById('star-count').innerText = stars;
        localStorage.setItem('pig_stars', stars);
    }

    // --- æ˜Ÿæ˜Ÿäº¤äº’ (ç‚¹å‡»å•ä¸ª) ---
    function spawnStar() {
        const zone = document.getElementById('star-zone');
        if (zone.children.length < 6 && !travelEndTime) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 80 + '%';
            star.style.top = Math.random() * 70 + '%';
            star.onclick = (e) => collectOneStar(e, star);
            zone.appendChild(star);
        }
    }

    function collectOneStar(e, el) {
        e.stopPropagation();
        stars += 1;
        updateUI();

        const gameView = document.getElementById('game-view');
        const gameRect = gameView.getBoundingClientRect();

        // +1 æµ®åŠ¨åŠ¨ç”»
        const floatText = document.createElement('div');
        floatText.className = 'float-text';
        floatText.innerText = '+1';
        floatText.style.left = (e.clientX - gameRect.left) + 'px';
        floatText.style.top = (e.clientY - gameRect.top) + 'px';
        gameView.appendChild(floatText);
        setTimeout(() => floatText.remove(), 1000);

        // æ¨¡æ‹Ÿé£è¡ŒåŠ¨ç”»
        const flyStar = document.createElement('div');
        flyStar.className = 'fly-star';
        flyStar.style.left = (e.clientX - gameRect.left) + 'px';
        flyStar.style.top = (e.clientY - gameRect.top) + 'px';
        gameView.appendChild(flyStar);
        
        // é£å‘å·¦ä¸Šè§’ä½™é¢ä½ç½®
        setTimeout(() => {
            const balanceEl = document.querySelector('.hud-balance');
            const rect = balanceEl.getBoundingClientRect();
            
            flyStar.style.left = (rect.left - gameRect.left + rect.width/2) + 'px';
            flyStar.style.top = (rect.top - gameRect.top + rect.height/2) + 'px';
            flyStar.style.opacity = '0';
        }, 50);
        setTimeout(() => flyStar.remove(), 800);

        el.remove();
    }

    // --- å•†åº—ä¸æ—…è¡Œ ---
    function renderShop() {
        const list = document.getElementById('shop-list');
        list.innerHTML = items.map(item => `
            <div class="shop-item">
                <div class="item-sprite" style="background-position: ${item.pos}"></div>
                <div>
                    <div><strong>${item.name}</strong></div>
                    <div style="font-size:12px; color:#666">â­ ${item.cost} / â³ ${item.time}åˆ†</div>
                </div>
                <button class="buy-btn" onclick="buyAndGo('${item.name}', ${item.cost}, ${item.time})">å‡ºå‘</button>
            </div>
        `).join('');
    }

    function buyAndGo(name, cost, mins) {
        if (stars < cost) return alert('æ˜Ÿæ˜Ÿä¸å¤Ÿå•¦ï¼');
        
        stars -= cost;
        updateUI();
        toggleShop(false);

        const endTime = Date.now() + mins * 60 * 1000;
        travelEndTime = endTime;
        localStorage.setItem('pig_travel_end', endTime);

        // åˆ‡æ¢èƒŒå½± -> æ¶ˆå¤±
        const pig = document.getElementById('pig-img');
        pig.src = 'assets/characters/pig_back.png';
        setTimeout(() => {
            document.querySelector('.pig-container').style.opacity = '0';
            alert(`å°çŒªå‡ºå‘äº†ï¼`);
        }, 1500);
    }

    function checkTravelStatus() {
        if (!travelEndTime) return;

        if (Date.now() > travelEndTime) {
            finishTravel();
        } else {
            document.querySelector('.pig-container').style.opacity = '0';
            setTimeout(checkTravelStatus, 1000);
        }
    }

    function finishTravel() {
        const newLoc = locations[Math.floor(Math.random() * locations.length)];
        
        if (!album.includes(newLoc.id)) {
            album.push(newLoc.id);
            localStorage.setItem('pig_album', JSON.stringify(album));
        }

        travelEndTime = null;
        localStorage.removeItem('pig_travel_end');
        
        const pigContainer = document.querySelector('.pig-container');
        const pigImg = document.getElementById('pig-img');
        pigImg.src = 'assets/characters/pig_idel.png';
        pigContainer.style.opacity = '1';

        alert('ğŸ‰ å°çŒªå›æ¥å•¦ï¼');
        showPhoto(newLoc.id);
        renderMap();
    }

    // --- åœ°å›¾ä¸åˆæˆ ---
    function renderMap() {
        const map = document.getElementById('map-view');
        map.innerHTML = '';
        
        locations.forEach(loc => {
            const isUnlocked = album.includes(loc.id);
            const pin = document.createElement('div');
            pin.className = `map-pin ${isUnlocked ? 'pin-unlocked' : 'pin-locked'}`;
            pin.style.left = loc.x + '%';
            pin.style.top = loc.y + '%';
            
            if (isUnlocked) {
                pin.onclick = () => showPhoto(loc.id);
            }
            map.appendChild(pin);
        });
    }

    function showPhoto(locId) {
        const loc = locations.find(l => l.id === locId);
        if (!loc) return;

        document.getElementById('p-bg').src = loc.img;
        document.getElementById('p-text').innerText = loc.text;
        
        // éšæœºæ„å›¾
        const pigChar = document.getElementById('p-char');
        const scale = 0.8 + Math.random() * 0.4; 
        pigChar.style.transform = `scale(${scale})`;
        
        toggleAlbum(false);
        document.getElementById('overlay-photo').style.display = 'block';
    }

    function closePhoto() { document.getElementById('overlay-photo').style.display = 'none'; }
    function switchScene(id) {
        document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function toggleShop(show) { document.getElementById('overlay-shop').style.display = show ? 'block' : 'none'; }
    function toggleAlbum(show) { 
        document.getElementById('overlay-album').style.display = show ? 'block' : 'none';
        if(show) renderMap();
    }
    function interactPig() {
        const img = document.getElementById('pig-img');
        if(img.src.includes('idel')) {
            img.src = 'assets/characters/pig_travel.png';
            setTimeout(() => img.src = 'assets/characters/pig_idel.png', 1500);
        }
    }

    window.onload = () => {
        updateUI();
        renderShop();
        renderMap();
        checkTravelStatus();
        setInterval(spawnStar, 10000); 
    };
</script>
</body>
</html>