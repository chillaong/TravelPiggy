<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title></title>
    <link href="https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #fdf6e3; --accent: #ff9d00; --text-font: 'Zhi Mang Xing', cursive; }
        body { margin: 0; background: #222; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: "PingFang SC", sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* 9:16 æ¸¸æˆå®¹å™¨ */
        #game-view { position: relative; width: 100vw; height: calc(100vw * 16 / 9); max-height: 100vh; max-width: calc(100vh * 9 / 16); background: var(--bg-color); overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        /* é€šç”¨åœºæ™¯ç±» */
        .scene { position: absolute; width: 100%; height: 100%; display: none; background-size: cover; background-position: center; }
        .active { display: block; }

        /* --- è§’è‰²åŠ¨ç”» --- */
        .pig-container { position: absolute; bottom: 3%; left: 50%; transform: translateX(-50%); width: 45%; cursor: pointer; z-index: 10; transition: opacity 0.5s; }
            /* Prevent initial flash when page loads during travel; disable interaction but keep transition so back animation can play */
            .traveling .pig-container { opacity: 0; pointer-events: none; }
        #pig-img { width: 100%; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2)); }
        .breathe { animation: breathe 3s ease-in-out infinite; }
        @keyframes breathe { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-3%) scale(1.02); } }

        /* --- åº­é™¢æ˜Ÿæ˜Ÿç³»ç»Ÿ (å‡çº§ç‰ˆ) --- */
        #star-zone { position: absolute; top: 60%; left: 10%; width: 80%; height: 25%; z-index: 5; pointer-events: none; }
        .star { 
            position: absolute; width: 50px; height: 50px; 
            /* ä½¿ç”¨æ–°çš„æ˜Ÿæ˜Ÿå›¾æ ‡ï¼Œå°ºå¯¸æ›´å°æ›´åè°ƒ */
            background: url('assets/ui/stars.png') no-repeat center;
            background-size: contain; 
            cursor: pointer; pointer-events: auto;
            animation: float 2s ease-in-out infinite;
            filter: drop-shadow(0 0 5px gold);
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        /* æ˜Ÿæ˜Ÿé£è¡ŒåŠ¨æ•ˆç²’å­ */
        .fly-star { position: absolute; width: 39px; height: 39px; background: gold; border-radius: 50%; pointer-events: none; z-index: 99; transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1); }
        .float-text { position: absolute; color: #ff9d00; font-weight: bold; font-size: 24px; pointer-events: none; animation: fadeUp 1s forwards; z-index: 100; text-shadow: 0 2px 0 white; }
        @keyframes fadeUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* --- UI ç•Œé¢ --- */
        /* é¡¶éƒ¨ä½™é¢ (æ”¹ä¸ºå³ä¸Šè§’å¸ƒå±€ï¼Œé¿è®©ç›¸å†ŒæŒ‰é’®) */
        .hud-balance { position: absolute; top: 25px; left: 20px; background: rgba(255,255,255,0.9); padding: 8px 15px; border-radius: 30px; font-weight: bold; font-size: 18px; display: flex; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 50; }
        .hud-icon { display: flex; align-items: center; justify-content: center; margin-right: 8px; }
        /* ç»´æŒç™½è‰²åº•æ¡†åŸæœ¬é«˜åº¦ï¼Œç”¨ç¼©æ”¾æ”¾å¤§å†…éƒ¨å›¾æ ‡ */
        .hud-icon img { height: 28px; width: auto; display: block; transform: scale(1.4); transform-origin: center; }
        /* å•†åº— & ç›¸å†Œå›¾æ ‡åŸºå‡†åŒä¸º 28pxï¼Œä½†ç¼©æ”¾æ¯”ä¾‹ä¸åŒï¼šç›¸å†Œç•¥å¤§ä¸€äº› */
        .btn-shop img { width: 28px; height: 28px; display: block; transform: scale(1.6); transform-origin: center; }
        .btn-album img { width: 28px; height: 28px; display: block; transform: scale(2.0); transform-origin: center; }
        
        /* ç›¸å†ŒæŒ‰é’® */
        .btn-album { position: absolute; top: 25px; right: 20px; background: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid #ddd; z-index: 50; display: flex; align-items: center; justify-content: center; }

        /* å•†åº—æŒ‰é’® (å·¦ä¸Šè§’æ˜Ÿæ˜Ÿä¸‹æ–¹) */
        .btn-shop { position: absolute; top: 78px; left: 20px; background: white; padding: 6px 12px; border-radius: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid #ddd; z-index: 50; display: flex; align-items: center; gap: 6px; }

        /* åº•éƒ¨å¯¼èˆª */
        .nav-bar { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box; pointer-events: none; }
        /* åº•éƒ¨æ©™è‰²åœ†å½¢æŒ‰é’®ï¼ˆèƒŒåŒ… / åˆ‡æ¢åº­é™¢å§å®¤ï¼‰ï¼Œç»Ÿä¸€ç¨å¾®ç¼©å°ä¸€ç‚¹ */
        .nav-btn { pointer-events: auto; width: 60px; height: 60px; background: white; border-radius: 50%; border: 4px solid var(--accent); box-shadow: 0 4px 0 #cc7e00; font-size: 26px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; }
        .nav-btn:active { transform: translateY(4px); box-shadow: none; }

        /* --- å¼¹çª—é€šç”¨ --- */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; z-index: 100; backdrop-filter: blur(5px); }
        #overlay-photo { z-index: 150; }
        .close-btn { position: absolute; top: 20px; right: 20px; font-size: 40px; color: white; cursor: pointer; z-index: 102; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        /* --- å•†åº—é¢æ¿ --- */
        #shop-panel { position: absolute; bottom: 0; width: 100%; height: 60%; background: #fffcf5; border-radius: 30px 30px 0 0; padding: 20px; box-sizing: border-box; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .shop-item { display: flex; align-items: center; background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 2px solid #eee; }
        .item-sprite { width: 50px; height: 50px; background-repeat: no-repeat; background-position: center; background-size: contain; margin-right: 15px; flex-shrink: 0; }
        .buy-btn { margin-left: auto; background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .buy-btn:disabled { background: #bbb; cursor: not-allowed; }

        /* --- èƒŒåŒ…é¢æ¿ --- */
        #backpack-panel { position: absolute; bottom: 0; width: 100%; height: 60%; background: #fffcf5; border-radius: 30px 30px 0 0; padding: 20px; box-sizing: border-box; overflow-y: auto; animation: slideUp 0.3s; }
        .backpack-slots { display: flex; gap: 10px; margin-bottom: 12px; }
        .backpack-slot { flex: 1; background: #fff; border: 2px dashed #ddd; border-radius: 12px; padding: 8px 10px; font-size: 14px; color: #666; min-height: 40px; display: flex; align-items: center; }
        .count-badge { background: #ffe1b0; color: #7a4a00; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px; }
        .select-btn { margin-left: auto; background: #ffd166; color: #6b3e00; border: none; padding: 6px 14px; border-radius: 16px; font-weight: bold; cursor: pointer; }
        .select-btn:disabled { background: #bbb; cursor: not-allowed; }
        .start-btn { width: 100%; background: #7fbf4d; color: white; border: none; padding: 10px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 8px; }
        .start-btn:disabled { background: #bbb; cursor: not-allowed; }

        /* --- ä¸–ç•Œåœ°å›¾ --- */
        /* æ³¨æ„ï¼šåœ°å›¾ UI æ”¾åœ¨ assets/ui/ ä¸‹ */
        #map-view { width: 100%; height: 100%; background: url('assets/ui/WorldMap_UI.jpg?v=20260208') no-repeat center center; background-size: cover; position: relative; }
        .map-pin { position: absolute; width: 40px; height: 40px; transform: translate(-50%, -100%); cursor: pointer; }
        .pin-locked { width: 20px; height: 20px; background: rgba(0,0,0,0.2); border-radius: 50%; border: 2px dashed #666; }
        /* è§£é”çš„ Pin å›¾ï¼Œä½¿ç”¨ pig å¤´åƒ */
        .pin-unlocked { 
            width: 50px; height: 50px; 
            background: url('assets/characters/pig_selfie.png?v=20260208') no-repeat center; 
            background-size: cover; 
            border-radius: 50%; border: 3px solid white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            animation: bounce 2s infinite; 
        }
        @keyframes bounce { 0%, 100% { transform: translate(-50%, -100%); } 50% { transform: translate(-50%, -110%); } }

        /* --- æ‹ç«‹å¾—ç…§ç‰‡è¯¦æƒ… --- */
        #photo-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; aspect-ratio: 3/4; perspective: 1000px; }
        .polaroid {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: visible;
            transform: rotate(-2deg);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transition: transform 0.3s;
            background: var(--bg-color, #fdf6e3); /* å¡«å……çº¸å¼ èƒŒæ™¯è‰²ï¼Œé¿å…é€æ˜è¾¹ç¼˜é€å‡ºæ·±è‰²èƒŒæ™¯ */
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            transform: translateZ(0); /* è§¦å‘å¤åˆå±‚ä»¥å‡å°‘æŠ—é”¯é½¿ä¼ªå½± */
            will-change: transform;
        }
        /* è¿™é‡Œçš„ frame ä¹Ÿåœ¨ ui æ–‡ä»¶å¤¹ */
        .polaroid img.frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            pointer-events: none;
            background-color: transparent;
            image-rendering: auto;
        }
        .polaroid img.bg {
            position: absolute;
            width: 96%;
            height: 88%;
            object-fit: cover; /* use cover to fill uniformly */
            top: 2%;
            left: 2%;
            z-index: 1;
            border-radius: 2px;
            display: block;
            background-color: var(--bg-color, #fdf6e3);
        }
        .polaroid img.char {
            position: absolute;
            bottom: 25%;
            right: 10%;
            width: 45%;
            height: auto;
            z-index: 5;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3));
            display: block;
            transform: scale(1);
            transform-origin: center;
        }
        .photo-text { position: absolute; bottom: 5%; width: 100%; text-align: center; font-family: 'Zhi Mang Xing', cursive; font-size: 30px; color: #444; z-index: 30; transform: rotate(2deg); opacity: 0.9; }

    </style>
        <script>
            try {
                const end = Number(localStorage.getItem('pig_travel_end')) || 0;
                if (end && Date.now() <= end) {
                    document.documentElement.classList.add('traveling');
                }
            } catch (e) {}
        </script>
</head>
<body>

<div id="game-view">
    <div id="scene-room" class="scene active" style="background-image: url('assets/scenes/room.png?v=20260208');">
        <div class="pig-container" onclick="interactPig()">
            <img id="pig-img" src="assets/characters/pig_idel.png?v=20260208" class="breathe" alt="">
        </div>
        <div class="nav-bar">
            <div class="nav-btn" onclick="toggleBackpack(true)">ğŸ’</div>
            <div class="nav-btn" onclick="switchScene('scene-garden')">ğŸ¡</div>
        </div>
    </div>

    <div id="scene-garden" class="scene" style="background-image: url('assets/scenes/magic_garden.png?v=20260208');">
        <div id="star-zone"></div>
        <div class="nav-bar" style="justify-content: center;">
            <div class="nav-btn" onclick="switchScene('scene-room')">ğŸ </div>
        </div>
    </div>

    <div class="hud-balance">
        <div class="hud-icon"><img src="assets/ui/stars.png" alt=""></div>
        <span id="star-count">0</span>
    </div>
    <div class="btn-shop" onclick="toggleShop(true)"><img src="assets/ui/stores.png" alt=""></div>
    <div class="btn-album" onclick="toggleAlbum(true)"><img src="assets/ui/diary.png" alt=""></div>

    <div id="overlay-shop" class="overlay" onclick="toggleShop(false)">
        <div id="shop-panel" onclick="event.stopPropagation()">
            <h2 id="shop-title" style="text-align:center; color:#555;"></h2>
            <div id="shop-list"></div>
        </div>
    </div>

    <div id="overlay-backpack" class="overlay" onclick="toggleBackpack(false)">
        <div id="backpack-panel" onclick="event.stopPropagation()">
            <h2 id="backpack-title" style="text-align:center; color:#555;"></h2>
            <div class="backpack-slots">
                <div class="backpack-slot" id="slot-food"></div>
                <div class="backpack-slot" id="slot-gear"></div>
            </div>
            <div id="backpack-list"></div>
            <button class="start-btn" id="start-travel-btn" onclick="startTravelFromSelection()"></button>
        </div>
    </div>

    <div id="overlay-album" class="overlay">
        <div class="close-btn" onclick="toggleAlbum(false)"></div>
        <div id="map-view">
            </div>
    </div>

    <div id="overlay-photo" class="overlay" onclick="closePhoto()">
        <div class="close-btn" onclick="closePhoto()"></div>
        <div id="photo-modal" onclick="event.stopPropagation()">
            <div class="polaroid" id="polaroid-card">
                <img class="frame" src="assets/ui/frame.png?v=20260208">
                <img class="bg" id="p-bg" src="">
                <img class="char" id="p-char" src="assets/characters/pig_selfie.png">
                <div class="photo-text" id="p-text"></div>
            </div>
            <button id="photo-prev" style="position:absolute; left:-10px; top:50%; transform:translateY(-50%); background:#fff; border:2px solid #ddd; border-radius:20px; padding:6px 10px; cursor:pointer;"></button>
            <button id="photo-next" style="position:absolute; right:-10px; top:50%; transform:translateY(-50%); background:#fff; border:2px solid #ddd; border-radius:20px; padding:6px 10px; cursor:pointer;"></button>
        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒé…ç½® ---
    let stars = 0;
    let album = JSON.parse(localStorage.getItem('pig_album')) || [];
    let travelEndTime = localStorage.getItem('pig_travel_end') || null;
    let locations = [];
    let items = [];
    let gameConfig = {};
    let uiText = {};
    let inventory = {};
    let albumRecords = JSON.parse(localStorage.getItem('pig_album_records')) || null;
    let travelPayload = JSON.parse(localStorage.getItem('pig_travel_payload')) || null;
    let selectedFoodName = null;
    let selectedGearName = null;

    // --- æµ‹è¯•æ¨¡å¼ï¼ˆé€šè¿‡ URL å‚æ•°å¯ç”¨ï¼Œä½¿ç”¨ ?test=1ï¼‰ ---
    const TEST_MODE = new URLSearchParams(window.location.search).get('test') === '1';
    const TEST_TRAVEL_MINUTES = 0.5; // 0.5 åˆ†é’Ÿï¼ˆ30 ç§’ï¼‰
    let __test_backup_prefix = null;

    function backupLocalStorageForTest() {
        if (!TEST_MODE) return;
        const keys = ['pig_stars','pig_inventory','pig_travel_end','pig_travel_payload','pig_album','pig_album_records'];
        __test_backup_prefix = 'pig_test_backup_' + Date.now();
        keys.forEach(k => {
            const v = localStorage.getItem(k);
            localStorage.setItem(__test_backup_prefix + '_' + k, v === null ? '__NULL__' : v);
        });
        console.log('TEST MODE: backed up localStorage keys with prefix', __test_backup_prefix);
    }

    function restoreLocalStorageFromTest() {
        if (!__test_backup_prefix) {
            console.warn('TEST MODE: no backup prefix found');
            return;
        }
        const keys = ['pig_stars','pig_inventory','pig_travel_end','pig_travel_payload','pig_album','pig_album_records'];
        keys.forEach(k => {
            const bk = localStorage.getItem(__test_backup_prefix + '_' + k);
            if (bk === null) return;
            if (bk === '__NULL__') localStorage.removeItem(k);
            else localStorage.setItem(k, bk);
            localStorage.removeItem(__test_backup_prefix + '_' + k);
        });
        console.log('TEST MODE: restored localStorage from backup prefix', __test_backup_prefix);
        __test_backup_prefix = null;
    }

    function applyTestOverridesAfterInit() {
        if (!TEST_MODE) return;
        try {
            backupLocalStorageForTest();
            // set stars
            localStorage.setItem('pig_stars', '1000');
            // set inventory: 99 of each item
            const inv = {};
            items.forEach(it => { inv[it.name] = 99; });
            localStorage.setItem('pig_inventory', JSON.stringify(inv));
            // reload in-memory inventory
            loadInventory();
            console.log('TEST MODE: applied overrides â€” stars=1000, each item count=99, travel time overridden to', TEST_TRAVEL_MINUTES, 'minutes');
            // expose restore function for convenience
            window.restoreTestData = restoreLocalStorageFromTest;
        } catch (e) {
            console.error('TEST MODE: failed to apply overrides', e);
        }
    }

    // --- CSV åŠ è½½å’Œè§£æ ---
    function parseCSV(text) {
        const rows = [];
        let row = [];
        let cell = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
            const ch = text[i];
            if (inQuotes) {
                if (ch === '"') {
                    if (text[i + 1] === '"') {
                        cell += '"';
                        i++;
                    } else {
                        inQuotes = false;
                    }
                } else {
                    cell += ch;
                }
            } else {
                if (ch === '"') {
                    inQuotes = true;
                } else if (ch === ',') {
                    row.push(cell);
                    cell = '';
                } else if (ch === '\n') {
                    row.push(cell);
                    rows.push(row);
                    row = [];
                    cell = '';
                } else if (ch !== '\r') {
                    cell += ch;
                }
            }
        }

        if (cell.length || row.length) {
            row.push(cell);
            rows.push(row);
        }

        const headers = (rows.shift() || []).map(h => h.trim());
        return rows
            .filter(r => r.some(c => c.trim() !== ''))
            .map(r => {
                const obj = {};
                headers.forEach((h, idx) => {
                    obj[h] = (r[idx] || '').trim();
                });
                return obj;
            });
    }

    async function loadCSV(path) {
        const response = await fetch(path, { cache: 'no-store' });
        const text = await response.text();
        return parseCSV(text);
    }

    async function loadUIText() {
        const rows = await loadCSV('assets/config/ui_text.csv');
        const dict = {};
        rows.forEach(row => {
            if (row.key) {
                dict[row.key] = row.text || '';
            }
        });
        return dict;
    }

    function t(key, fallback = '') {
        if (uiText && Object.prototype.hasOwnProperty.call(uiText, key)) {
            return uiText[key] || fallback;
        }
        return fallback;
    }

    // åŠ è½½æ¸¸æˆé…ç½®
    async function loadGameConfig() {
        const configData = await loadCSV('assets/config/game_config.csv');
        const config = {};
        configData.forEach(row => {
            config[row.key] = isNaN(row.value) ? row.value : parseFloat(row.value);
        });
        return config;
    }

    // åˆå§‹åŒ–æ¸¸æˆæ•°æ®
    async function initGameData() {
        const rawLocations = await loadCSV('assets/config/locations.csv');
        const rawItems = await loadCSV('assets/config/items.csv');
        gameConfig = await loadGameConfig();
        uiText = await loadUIText();
        
        const defaults = {
            initial_stars: 20,
            star_max_count: 6,
            pig_travel_check_interval: 30000,
            star_refresh_rate: 10000,
            weighted_prob: 0.9,
            stars_per_second: 0
        };
        gameConfig = { ...defaults, ...gameConfig };

        items = rawItems.map(item => ({
            name: item.name,
            cost: Number(item.cost) || 0,
            time: Number(item.time) || 0,
            img: item.img,
            tier: Number(item.tier) || 0,
            type: item.type,
            effect: item.effect,
            stock: Number(item.stock) || 0
        }));

        locations = rawLocations.map(loc => ({
            id: loc.id,
            name: loc.name,
            x: Number(loc.x) || 0,
            y: Number(loc.y) || 0,
            tier: Number(loc.tier) || 0,
            img: loc.img,
            img_B: loc.img_B,
            text1: loc.text1,
            text2: loc.text2,
            text3: loc.text3
        }));

        if (!albumRecords || !Array.isArray(albumRecords)) {
            const legacyAlbum = JSON.parse(localStorage.getItem('pig_album')) || [];
            albumRecords = legacyAlbum
                .map(id => {
                    const loc = locations.find(entry => entry.id === id);
                    if (!loc) return null;
                    return {
                        locationId: id,
                        angle: 'A',
                        img: loc.img,
                        text: loc.text1 || '',
                        count: 1,
                        stamp: false
                    };
                })
                .filter(Boolean);
            localStorage.setItem('pig_album_records', JSON.stringify(albumRecords));
        }

        stars = parseInt(localStorage.getItem('pig_stars')) || gameConfig.initial_stars;
        loadInventory();
    }

    function applyUIText() {
        document.title = t('page_title', document.title || '');

        const pigImg = document.getElementById('pig-img');
        if (pigImg) pigImg.alt = t('alt_pig', '');

        const starIcon = document.querySelector('.hud-icon img');
        if (starIcon) starIcon.alt = t('alt_star', '');

        const shopIcon = document.querySelector('.btn-shop img');
        if (shopIcon) shopIcon.alt = t('alt_shop', '');

        const albumIcon = document.querySelector('.btn-album img');
        if (albumIcon) albumIcon.alt = t('alt_album', '');

        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.textContent = t('close_btn', '');
        });

        const shopTitle = document.getElementById('shop-title');
        if (shopTitle) shopTitle.innerText = t('shop_title', '');

        const backpackTitle = document.getElementById('backpack-title');
        if (backpackTitle) backpackTitle.innerText = t('backpack_title', '');

        const slotFood = document.getElementById('slot-food');
        const slotGear = document.getElementById('slot-gear');
        if (slotFood) slotFood.textContent = `${t('slot_food_label', '')}ï¼š${t('slot_not_selected', '')}`;
        if (slotGear) slotGear.textContent = `${t('slot_gear_label', '')}ï¼š${t('slot_not_selected', '')}`;

        const startBtn = document.getElementById('start-travel-btn');
        if (startBtn) startBtn.textContent = t('start_button', '');

        const btnPrev = document.getElementById('photo-prev');
        const btnNext = document.getElementById('photo-next');
        if (btnPrev) btnPrev.textContent = t('photo_prev', '');
        if (btnNext) btnNext.textContent = t('photo_next', '');
    }

    function updateUI() {
        document.getElementById('star-count').innerText = stars;
        localStorage.setItem('pig_stars', stars);
    }

    function loadInventory() {
        const raw = JSON.parse(localStorage.getItem('pig_inventory')) || {};
        inventory = items.reduce((acc, item) => {
            const stored = parseInt(raw[item.name], 10);
            acc[item.name] = Number.isNaN(stored) ? item.stock : stored;
            return acc;
        }, {});
    }

    function saveInventory() {
        localStorage.setItem('pig_inventory', JSON.stringify(inventory));
    }

    // --- æ˜Ÿæ˜Ÿäº¤äº’ (ç‚¹å‡»å•ä¸ª) ---
    function spawnStar() {
        const zone = document.getElementById('star-zone');
        if (zone.children.length < gameConfig.star_max_count && !travelEndTime) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 80 + '%';
            star.style.top = Math.random() * 70 + '%';
            star.onclick = (e) => collectOneStar(e, star);
            zone.appendChild(star);
        }
    }

    function collectOneStar(e, el) {
        e.stopPropagation();
        stars += 1;
        updateUI();

        const gameView = document.getElementById('game-view');
        const gameRect = gameView.getBoundingClientRect();

        // +1 æµ®åŠ¨åŠ¨ç”»
        const floatText = document.createElement('div');
        floatText.className = 'float-text';
        floatText.innerText = t('float_text_plus_one', '');
        floatText.style.left = (e.clientX - gameRect.left) + 'px';
        floatText.style.top = (e.clientY - gameRect.top) + 'px';
        gameView.appendChild(floatText);
        setTimeout(() => floatText.remove(), 1000);

        // æ¨¡æ‹Ÿé£è¡ŒåŠ¨ç”»
        const flyStar = document.createElement('div');
        flyStar.className = 'fly-star';
        flyStar.style.left = (e.clientX - gameRect.left) + 'px';
        flyStar.style.top = (e.clientY - gameRect.top) + 'px';
        gameView.appendChild(flyStar);
        
        // é£å‘å·¦ä¸Šè§’ä½™é¢ä½ç½®
        setTimeout(() => {
            const balanceEl = document.querySelector('.hud-balance');
            const rect = balanceEl.getBoundingClientRect();
            
            flyStar.style.left = (rect.left - gameRect.left + rect.width/2) + 'px';
            flyStar.style.top = (rect.top - gameRect.top + rect.height/2) + 'px';
            flyStar.style.opacity = '0';
        }, 50);
        setTimeout(() => flyStar.remove(), 800);

        el.remove();
    }

    // --- å•†åº—ä¸æ—…è¡Œ ---
    function renderShop() {
        const list = document.getElementById('shop-list');
        const priceTimeTemplate = t('shop_price_time', '');
        list.innerHTML = items.map(item => `
            <div class="shop-item">
                <div class="item-sprite" style="background-image: url('${item.img}')"></div>
                <div>
                    <div><strong>${item.name}</strong></div>
                    <div style="font-size:12px; color:#666">${priceTimeTemplate.replace('{cost}', item.cost).replace('{time}', item.time)}</div>
                </div>
                <button class="buy-btn" onclick="buyItem('${item.name}', ${item.cost})">${t('btn_buy', '')}</button>
            </div>
        `).join('');
    }

    function renderBackpack() {
        const list = document.getElementById('backpack-list');
        const slotFood = document.getElementById('slot-food');
        const slotGear = document.getElementById('slot-gear');
        const startBtn = document.getElementById('start-travel-btn');
        const selectedFood = items.find(item => item.name === selectedFoodName);
        const selectedGear = items.find(item => item.name === selectedGearName);

        const foodLabel = t('slot_food_label', '');
        const gearLabel = t('slot_gear_label', '');
        const notSelectedLabel = t('slot_not_selected', '');

        slotFood.textContent = `${foodLabel}ï¼š${selectedFood ? selectedFood.name : notSelectedLabel}`;
        slotGear.textContent = `${gearLabel}ï¼š${selectedGear ? selectedGear.name : notSelectedLabel}`;

        const canStart = !!selectedFoodName && !travelEndTime;
        startBtn.disabled = !canStart;

        list.innerHTML = items.map(item => {
            const count = inventory[item.name] || 0;
            const disabled = count === 0 || travelEndTime;
            const isSelected = item.name === selectedFoodName || item.name === selectedGearName;
            const btnLabel = isSelected ? t('btn_selected', '') : t('btn_select', '');
            const timeLabel = t('time_label', '').replace('{time}', item.time);
            return `
                <div class="shop-item">
                    <div class="item-sprite" style="background-image: url('${item.img}')"></div>
                    <div>
                        <div><strong>${item.name}</strong><span class="count-badge">x${count}</span></div>
                        <div style="font-size:12px; color:#666">${timeLabel}</div>
                    </div>
                    <button class="select-btn" onclick="selectBackpackItem('${item.name}')" ${disabled ? 'disabled' : ''}>${btnLabel}</button>
                </div>
            `;
        }).join('');
    }

    function buyItem(name, cost) {
        if (stars < cost) return alert(t('alert_not_enough_stars', ''));
        stars -= cost;
        updateUI();
        inventory[name] = (inventory[name] || 0) + 1;
        saveInventory();
        renderBackpack();
        alert(t('alert_buy_success', '').replace('{name}', name));
    }

    function selectBackpackItem(name) {
        if (travelEndTime) return;
        if (!inventory[name]) return alert(t('alert_no_item', ''));

        const item = items.find(entry => entry.name === name);
        if (!item) return;

        if (item.type === 'food') {
            selectedFoodName = name;
        } else if (item.type === 'gear') {
            selectedGearName = name;
        } else {
            // Fallback: allow any item to be used as a travel item
            selectedFoodName = name;
        }

        renderBackpack();
    }

    function startTravelFromSelection() {
        if (travelEndTime) return alert(t('alert_travel_ongoing', ''));

        const chosenName = selectedFoodName || selectedGearName;
        if (!chosenName) return alert(t('alert_select_food', ''));
        if (selectedFoodName && !inventory[selectedFoodName]) return alert(t('alert_no_food_in_inventory', ''));
        if (selectedGearName && !inventory[selectedGearName]) return alert(t('alert_no_item', ''));

        if (selectedFoodName) {
            inventory[selectedFoodName] -= 1;
        }
        if (selectedGearName) {
            inventory[selectedGearName] -= 1;
        }
        saveInventory();
        renderBackpack();
        toggleBackpack(false);

        const foodItem = items.find(item => item.name === selectedFoodName);
        const gearItem = items.find(item => item.name === selectedGearName);
        const travelItem = foodItem || gearItem;

        if (!travelItem) return;

        selectedFoodName = null;
        selectedGearName = null;

        beginTravel(travelItem, gearItem);
    }

    function pickTravelLocation(tier) {
        const weighted = Number(gameConfig.weighted_prob) || 0.9;
        if (tier === 1) {
            const tier1 = locations.filter(loc => loc.tier === 1);
            return tier1.length ? tier1 : locations;
        }

        const roll = Math.random();
        const primary = locations.filter(loc => loc.tier === tier);
        const fallback = locations.filter(loc => loc.tier === 1);

        if (roll <= weighted && primary.length) return primary;
        if (fallback.length) return fallback;
        return primary.length ? primary : locations;
    }

    function beginTravel(travelItem, gearItem) {
        const durationMinutes = TEST_MODE ? TEST_TRAVEL_MINUTES : travelItem.time;
        const endTime = Date.now() + durationMinutes * 60 * 1000;
        travelEndTime = endTime;
        localStorage.setItem('pig_travel_end', endTime);

        const candidateList = pickTravelLocation(travelItem.tier);
        const chosen = candidateList[Math.floor(Math.random() * candidateList.length)];
        travelPayload = {
            locationId: chosen.id,
            foodName: travelItem.name,
            gearName: gearItem ? gearItem.name : '',
            gearEffect: gearItem ? gearItem.effect : 'none'
        };
        localStorage.setItem('pig_travel_payload', JSON.stringify(travelPayload));

        // æ ‡è®°æ­£åœ¨å‡ºå‘å¹¶ç¦æ­¢äº¤äº’ï¼ˆCSS + inline åŒé‡ä¿éšœï¼‰
        try { document.documentElement.classList.add('traveling'); } catch(e) {}

        // åˆ‡æ¢èƒŒå½± -> æ¸éšæ¶ˆå¤±
        const pig = document.getElementById('pig-img');
        pig.src = 'assets/characters/pig_back.png';
        
        const pigContainer = document.querySelector('.pig-container');
        try {
            pigContainer.style.pointerEvents = 'none';
            pigContainer.style.cursor = 'default';
            pigContainer.onclick = null;
        } catch(e) {}

        pigContainer.style.transition = 'opacity 3s ease-out';
        pigContainer.style.opacity = '1';
        
        setTimeout(() => {
            pigContainer.style.opacity = '0';
        }, 100);
        
        const comboName = gearItem ? `${travelItem.name} + ${gearItem.name}` : travelItem.name;

        setTimeout(() => {
            alert(t('alert_travel_started', '').replace('{comboName}', comboName));
            checkTravelStatus();
        }, 3000);
    }

    function checkTravelStatus() {
        if (!travelEndTime) return;

        if (Date.now() > travelEndTime) {
            finishTravel();
        } else {
            const pigContainer = document.querySelector('.pig-container');
            // Avoid a fade-in flash after refresh while traveling
            pigContainer.style.transition = 'none';
            pigContainer.style.opacity = '0';
            setTimeout(checkTravelStatus, gameConfig.pig_travel_check_interval);
        }
    }

    function finishTravel() {
        const targetId = travelPayload?.locationId;
        const newLoc = locations.find(loc => loc.id === targetId) || locations[Math.floor(Math.random() * locations.length)];
        const textOptions = [newLoc.text1, newLoc.text2, newLoc.text3].filter(Boolean);
        const lockedText = textOptions.length ? textOptions[Math.floor(Math.random() * textOptions.length)] : '';

        const applyStamp = travelPayload?.gearEffect === 'stamp';
        const applyDouble = travelPayload?.gearEffect === 'double';

        // Debug: log travel payload / location / effect and check img_B accessibility
        try {
            console.log('finishTravel payload', { travelPayload, applyStamp, applyDouble, newLoc });
            if (applyDouble && newLoc && newLoc.img_B) {
                const _imgCheck = new Image();
                _imgCheck.onload = () => console.log('img_B loaded OK', newLoc.img_B);
                _imgCheck.onerror = () => console.warn('img_B failed to load', newLoc.img_B);
                _imgCheck.src = newLoc.img_B;
            } else if (applyDouble) {
                console.warn('applyDouble true but newLoc.img_B missing or falsy', newLoc && newLoc.img_B);
            }
        } catch (e) { console.warn('finishTravel debug logging failed', e); }

        const updateRecord = (angle) => {
            const existing = albumRecords.find(record => record.locationId === newLoc.id && record.angle === angle);
            if (existing) {
                existing.count += 1;
                existing.stamp = existing.stamp || applyStamp;
            } else {
                albumRecords.push({
                    locationId: newLoc.id,
                    angle,
                    text: lockedText,
                    count: 1,
                    stamp: applyStamp
                });
            }
        };

        if (!Array.isArray(albumRecords)) {
            albumRecords = [];
        }

        updateRecord('A');
        if (applyDouble) {
            if (newLoc.img_B) {
                updateRecord('B');
            } else {
                // If location has no B-angle image, give an extra A (increment count)
                updateRecord('A');
            }
        }

        localStorage.setItem('pig_album_records', JSON.stringify(albumRecords));

        travelEndTime = null;
        localStorage.removeItem('pig_travel_end');
        
        const pigContainer = document.querySelector('.pig-container');
        const pigImg = document.getElementById('pig-img');
        pigImg.src = 'assets/characters/pig_idel.png';
        pigContainer.style.opacity = '1';
        // æ¢å¤äº¤äº’
        try { document.documentElement.classList.remove('traveling'); } catch(e) {}
        try { pigContainer.style.pointerEvents = ''; pigContainer.style.cursor = 'pointer'; pigContainer.onclick = interactPig; } catch(e) {}

        travelPayload = null;
        localStorage.removeItem('pig_travel_payload');

        alert(t('alert_travel_finished', ''));
        showPhoto(newLoc.id, 'A');
        renderMap();
        renderBackpack();
    }

    // --- åœ°å›¾ä¸åˆæˆ ---
    function renderMap() {
        const map = document.getElementById('map-view');
        map.innerHTML = '';
        // åªæ¸²æŸ“å·²è§£é”çš„åœ°ç‚¹ï¼Œæœªè§£é”ä¸æ˜¾ç¤º pin
        const unlockedIds = new Set((albumRecords || []).map(record => record.locationId));

        locations
            .filter(loc => unlockedIds.has(loc.id))
            .forEach(loc => {
                const pin = document.createElement('div');
                pin.className = 'map-pin pin-unlocked';
                pin.style.left = loc.x + '%';
                pin.style.top = loc.y + '%';
                pin.onclick = () => showPhoto(loc.id, 'A');
                map.appendChild(pin);
            });
    }

    function showPhoto(locId, angle) {
        const records = albumRecords.filter(record => record.locationId === locId);
        if (!records.length) return;

        const targetAngle = angle || (records.some(r => r.angle === 'A') ? 'A' : records[0].angle);
        const record = records.find(r => r.angle === targetAngle) || records[0];
        const loc = locations.find(entry => entry.id === locId);
        const pBg = document.getElementById('p-bg');
        const pText = document.getElementById('p-text');
        const stampEl = document.getElementById('p-stamp');
        const btnPrev = document.getElementById('photo-prev');
        const btnNext = document.getElementById('photo-next');

        if (loc) {
            if (targetAngle === 'B' && loc.img_B) {
                pBg.src = loc.img_B;
            } else {
                pBg.src = loc.img;
            }
        } else {
            pBg.src = record.img || '';
        }
        pText.innerText = record.text || '';

        if (record.stamp) {
            if (!stampEl) {
                const stamp = document.createElement('img');
                stamp.id = 'p-stamp';
                stamp.src = 'assets/ui/camera_stamp.svg';
                stamp.style.position = 'absolute';
                stamp.style.right = '8%';
                stamp.style.top = '8%';
                stamp.style.width = '30%';
                stamp.style.transform = 'rotate(-8deg)';
                stamp.style.zIndex = '25';
                document.getElementById('polaroid-card').appendChild(stamp);
            }
        } else if (stampEl) {
            stampEl.remove();
        }

        const hasA = records.some(r => r.angle === 'A');
        const hasB = records.some(r => r.angle === 'B');
        if (btnPrev && btnNext) {
            const showToggle = hasA && hasB;
            btnPrev.style.display = showToggle ? 'block' : 'none';
            btnNext.style.display = showToggle ? 'block' : 'none';
            btnPrev.onclick = () => showPhoto(locId, 'A');
            btnNext.onclick = () => showPhoto(locId, 'B');
        }

        // å›ºå®šå°çŒªæ˜¾ç¤ºå¤§å°ï¼ˆç§»é™¤éšæœºç¼©æ”¾ï¼‰
        const pigChar = document.getElementById('p-char');
        if (pigChar) pigChar.style.transform = 'scale(1)';
        
        document.getElementById('overlay-photo').style.display = 'block';
    }

    function closePhoto() { 
        document.getElementById('overlay-photo').style.display = 'none';
    }
    function switchScene(id) {
        document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function toggleShop(show) { document.getElementById('overlay-shop').style.display = show ? 'block' : 'none'; }
    function toggleBackpack(show) { 
        document.getElementById('overlay-backpack').style.display = show ? 'block' : 'none';
        if (show) renderBackpack();
    }
    function toggleAlbum(show) { 
        document.getElementById('overlay-album').style.display = show ? 'block' : 'none';
        if(show) renderMap();
    }
    function interactPig() {
        const img = document.getElementById('pig-img');
        if(img.src.includes('idel')) {
            img.src = 'assets/characters/pig_travel.png';
            setTimeout(() => img.src = 'assets/characters/pig_idel.png', 1500);
        }
    }

    function applyTravelVisualState() {
        const pigContainer = document.querySelector('.pig-container');
        const pigImg = document.getElementById('pig-img');
        const root = document.documentElement;

        if (travelEndTime && Date.now() <= travelEndTime) {
            root.classList.add('traveling');
            pigImg.src = 'assets/characters/pig_back.png';
            pigContainer.style.transition = 'none';
            pigContainer.style.opacity = '0';
            requestAnimationFrame(() => {
                pigContainer.style.transition = '';
            });
        } else {
            root.classList.remove('traveling');
            pigContainer.style.opacity = '1';
        }
    }

    // --- åˆå§‹åŒ–æ¸¸æˆ ---
    window.onload = async () => {
        await initGameData();
        // apply test overrides (if ?test=1 is present in URL)
        applyTestOverridesAfterInit();
        applyUIText();
        applyTravelVisualState();
        updateUI();
        renderShop();
        renderBackpack();
        renderMap();
        checkTravelStatus();
        const rate = Number(gameConfig.stars_per_second) || 0;
        const refreshMs = rate > 0 ? Math.max(100, Math.round(1000 / rate)) : gameConfig.star_refresh_rate;
        setInterval(spawnStar, refreshMs); 
    };
</script>
</body>
</html>